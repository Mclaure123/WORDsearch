<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WORD SEARCH v1.0.0 (r23 - STABLE)</title>
    <style>
        :root {
            --color-bg-primary: #0A0A0A; --color-surface: #141414; --color-func: #2A2A2A; --color-text-passive: #B0B0B0; --color-text-bright: #FFFFFF; --color-accent-primary: #00FFFF; --color-accent-primary-glow: rgba(0, 255, 255, 0.4); --color-accent-bios: #00FF8A; --color-error: #FF414B; --color-success: #39FF14; --color-accent-gold: #FFD700;
            --gap-s: clamp(4px, 1vmin, 8px);
            --gap-m: clamp(8px, 2vmin, 16px);
            --gap-l: clamp(16px, 4vmin, 32px);
            --key-size: clamp(30px, min(10vw, 10vh), 65px);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { height: 100%; font-size: clamp(10px, 2.5vmin, 22px); }
        body { width: 100%; height: 100%; overflow: hidden; background-color: var(--color-bg-primary); color: var(--color-text-bright); font-family: Consolas, Menlo, Courier New, monospace; font-size: 1rem; position: relative; }
        #perspective-container { perspective: 1200px; width: 100%; height: 100%; position: relative; }
        body::after { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; background: repeating-linear-gradient(0deg, rgba(0,0,0,0.5) 0px, rgba(0,0,0,0.4) 1px, transparent 2px, transparent 3px); z-index: 10; animation: scanline-scroll 20s linear infinite; }
        @keyframes scanline-scroll { to { background-position-y: 100%; } }
        body::before {
            --grid-size: 40px; --grid-x: 0px; --grid-y: 0px;
            content: ""; position: absolute; top: -10%; left: -10%; width: 120%; height: 120%; pointer-events: none;
            background-image: linear-gradient(var(--color-surface) 1px, transparent 1px), linear-gradient(90deg, var(--color-surface) 1px, transparent 1px);
            background-size: var(--grid-size) var(--grid-size); background-position: var(--grid-x) var(--grid-y);
            opacity: 0.05; z-index: -1; transition: background-position 0.2s linear;
        }
        main { width: 100%; height: 100%; position: absolute; top: 0; left: 0; transform-style: preserve-3d; }
        .window { width: 100%; height: 100%; padding: var(--gap-m) var(--gap-l); position: absolute; top: 0; left: 0; display: flex; flex-direction: column; justify-content: space-between; align-items: center; text-align: center; opacity: 0; transform: translateZ(-200px); pointer-events: none; visibility: hidden; transition: opacity 300ms ease-out, transform 300ms ease-out, visibility 300ms; }
        .window.active { opacity: 1; transform: translateZ(0px); pointer-events: auto; visibility: visible; }
        .window-content { flex-grow: 1; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: var(--gap-m) 0; min-height: 0; }
        #preload, #title { justify-content: center; }
        h1 { font-size: clamp(2rem, 10vmin, 5rem); color: var(--color-accent-primary); letter-spacing: clamp(4px, 1vmin, 8px); text-shadow: 0 0 5px var(--color-accent-primary), 0 0 15px var(--color-accent-primary), 0 0 25px var(--color-accent-primary); max-width: 100%; word-break: break-word; }
        h2 { font-size: clamp(1.2rem, 4vmin, 1.8rem); color: var(--color-text-bright); margin-bottom: var(--gap-m); }
        h3 { font-size: clamp(1rem, 3.5vmin, 1.5rem); color: var(--color-accent-primary); margin-bottom: var(--gap-m); border-bottom: 1px solid var(--color-func); padding-bottom: var(--gap-m); text-align: left; width: 100%;}
        .interactive-button, button { background-color: var(--color-func); border: 2px solid var(--color-surface); color: var(--color-text-bright); padding: var(--gap-s) var(--gap-m); font-family: inherit; font-size: clamp(0.9rem, 2.5vmin, 1.2rem); cursor: pointer; text-transform: uppercase; transition: background-color 220ms, border-color 220ms, color 220ms, opacity 220ms, transform 220ms; flex-shrink: 0; }
        .interactive-button:hover, button:hover { background-color: var(--color-surface); border-color: var(--color-accent-primary); }
        .interactive-button:disabled { background-color: #1a1a1a; border-color: #111; color: #444; cursor: not-allowed; }
        .telemetry-header, .telemetry-footer { width: 100%; flex-shrink: 0; text-transform: uppercase; color: var(--color-text-passive); font-size: clamp(0.7rem, 2vmin, 0.9rem); letter-spacing: 2px; }
        .telemetry-header { display: flex; justify-content: space-between; align-items: center; padding: var(--gap-s); border-bottom: 1px solid var(--color-surface); }
        .telemetry-footer { padding: var(--gap-s); border-top: 1px solid var(--color-surface); }
        
        .menu-list { display: flex; flex-direction: column; gap: var(--gap-m); width: clamp(320px, 80vw, 800px); }
        #profilesList { list-style: none; }
        .profile-entry { display: flex; gap: var(--gap-s); align-items: center; width: 100%; }
        .profile-button { flex-grow: 1; text-align: left; }
        .delete-button { flex-shrink: 0; background-color: var(--color-error); border-color: #8B0000; width: 44px; height: 44px; font-size: 1.2rem; padding: 0; }
        
        .level-card { width: 100%; display: flex; align-items: center; justify-content: space-between; padding: var(--gap-s) var(--gap-m); text-align: left; }
        .rank-badge { width: clamp(50px, 12vmin, 70px); aspect-ratio: 1 / 1.2; margin-right: var(--gap-m); background: var(--color-accent-gold); clip-path: polygon(0% 0%, 100% 0%, 100% 80%, 50% 100%, 0% 80%); padding: 2px; }
        .rank-glyph { width: 100%; height: 100%; background: var(--color-surface); clip-path: polygon(0% 0%, 100% 0%, 100% 80%, 50% 100%, 0% 80%); display: flex; align-items: center; justify-content: center; font-size: clamp(1.8rem, 8vmin, 2.8rem); color: var(--color-accent-gold); text-shadow: 0 0 8px var(--color-accent-gold); }
        .level-card .level-info { flex-grow: 1; }
        .level-card .level-name { font-size: clamp(1rem, 3.5vmin, 1.6rem); color: var(--color-text-bright); display: block; }
        .level-card .rank-name { font-size: clamp(0.8rem, 2.5vmin, 1.1rem); color: var(--color-text-passive); display: block; }
        .level-card .repetition-container { display: flex; gap: var(--gap-s); margin-left: var(--gap-m); }
        .repetition-box { width: clamp(16px, 4vmin, 24px); height: clamp(16px, 4vmin, 24px); border: 2px solid var(--color-func); background-color: transparent; transition: background-color 300ms; }
        .repetition-box.filled { background-color: var(--color-accent-primary); }

        #victoryRankProgress { margin: var(--gap-l) 0; }
        .promotion-title { font-size: 1.5rem; color: var(--color-accent-gold); text-shadow: 0 0 10px var(--color-accent-gold); }

        #holographic-panel { display: flex; flex-direction: row; flex-wrap: nowrap; align-items: stretch; justify-content: center; gap: var(--gap-l); transform-style: preserve-3d; transform: rotateX(10deg); filter: drop-shadow(0 0 15px var(--color-accent-primary-glow)); width: auto; max-width: 95%; height: 85%; }
        #wordSearchGrid { display: grid; gap: 4px; background-color: rgba(0,0,0,0.2); padding: var(--gap-s); border: 2px solid var(--color-func); touch-action: none; height: 100%; aspect-ratio: 1 / 1; grid-template-columns: repeat(var(--grid-size, 10), 1fr); }
        .grid-cell { display: flex; justify-content: center; align-items: center; font-size: clamp(1rem, 4vmin, 2.5rem); color: var(--color-text-passive); background-color: var(--color-surface); cursor: pointer; user-select: none; transition: background-color 150ms, color 150ms, transform 100ms; }
        .grid-cell.selected { background-color: var(--color-accent-primary); color: var(--color-bg-primary) !important; transform: scale(1.1); }
        .grid-cell.found { background-color: var(--color-success) !important; color: var(--color-bg-primary) !important; transition: background-color 1s, color 1s; }
        .grid-cell.found.inactive { background-color: var(--color-func) !important; color: #444 !important; }
        .grid-cell.hint { animation: hint-pulse 0.8s 2; }
        @keyframes hint-pulse { 50% { background-color: var(--color-accent-gold); color: var(--color-bg-primary); } }
        
        #wordListContainer { background-color: var(--color-surface); border: 2px solid var(--color-func); padding: var(--gap-m); width: clamp(220px, 30vw, 350px); height: 100%; display: flex; flex-direction: column;}
        #wordList { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: var(--gap-s); flex-grow: 1; }
        #wordList li { font-size: clamp(0.9rem, 2.8vmin, 1.4rem); color: var(--color-text-bright); transition: all 220ms; text-align: left; padding: var(--gap-s); border: 1px solid transparent; }
        #wordList li.found { color: var(--color-text-passive); text-decoration: line-through; opacity: 0.5; }
        #wordList li.active-word { color: var(--color-accent-gold); border-color: var(--color-accent-gold); box-shadow: 0 0 10px var(--color-accent-gold); }

        #game-hud { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-top: var(--gap-m); }
        #word-timer { font-size: 2rem; color: var(--color-accent-gold); }
        
        #shopGrid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--gap-m); width: 100%; max-width: 800px; }
        .shop-item { background-color: var(--color-surface); border: 2px solid var(--color-func); padding: var(--gap-m); }
        .shop-item .cost { color: var(--color-accent-gold); margin: var(--gap-m) 0; }
        
        @media (max-aspect-ratio: 1/1) {
            #holographic-panel { flex-direction: column; align-items: center; gap: var(--gap-m); width: 95%; height: auto; }
            #wordSearchGrid { width: 100%; height: auto; }
            #wordListContainer { width: 100%; max-width: 600px; height: clamp(150px, 25vh, 200px); order: 2; }
        }
    </style>
</head>
<body>
    <div id="perspective-container">
        <main id="appContainer">
            <div id="preload" class="window active"><h1>CARGANDO...</h1></div>
            <div id="title" class="window"><h1>WORD SEARCH</h1><p>PRESIONA CUALQUIER TECLA PARA CONTINUAR</p></div>
            
            <div id="profiles" class="window">
                <header class="telemetry-header"><span>WORD SEARCH :: SELECT PROFILE</span></header>
                <div class="window-content"><h2>PERFILES DE USUARIO</h2><ul id="profilesList" class="menu-list"></ul><button id="goToPlayerCreateButton" class="interactive-button">CREAR NUEVO PERFIL</button></div>
                <footer class="telemetry-footer">BUILD: v1.0.0-r23</footer>
            </div>

            <div id="player" class="window">
                 <header class="telemetry-header"><span>WORD SEARCH :: CREATE PROFILE</span></header>
                 <div class="window-content"><h2>NUEVO JUGADOR</h2><div id="playerNameDisplay">_</div><div id="virtualKeyboard"></div><button id="cancelPlayerButton" style="margin-top: var(--gap-m);">CANCELAR</button></div>
                 <footer class="telemetry-footer">BUILD: v1.0.0-r23</footer>
            </div>

            <div id="mainMenu" class="window">
                <header class="telemetry-header"><span>WORD SEARCH :: MAIN MENU</span></header>
                <div class="window-content">
                    <h2 id="mainMenuHeader"></h2>
                    <div id="levelGrid" class="menu-list"></div>
                    <div style="display:flex; gap: var(--gap-m); margin-top:var(--gap-l);">
                        <button id="goToShopButton">TIENDA</button>
                        <button id="backToProfilesButton">CAMBIAR PERFIL</button>
                    </div>
                </div>
                <footer class="telemetry-footer">BUILD: v1.0.0-r23</footer>
            </div>
            
            <div id="shop" class="window">
                <header class="telemetry-header"><span id="shop-header">TIENDA</span></header>
                <div class="window-content">
                    <h2>CONSUMIBLES</h2>
                    <div id="shopGrid"></div>
                    <button id="backToMenuButton" style="margin-top:var(--gap-l);">VOLVER AL MENÚ</button>
                </div>
                <footer class="telemetry-footer">BUILD: v1.0.0-r23</footer>
            </div>

            <div id="game" class="window">
                <header class="telemetry-header"><span id="gameHeaderTitle">JUGADOR :: CARGANDO...</span></header>
                <div class="window-content"><div id="holographic-panel"><div id="wordSearchGrid"></div><div id="wordListContainer"><h3>PALABRAS A ENCONTRAR</h3><ul id="wordList"></ul><div id="game-hud"><button id="hint-button">[ PISTA (0) ]</button><div id="word-timer">00:00</div></div></div></div></div>
                <footer class="telemetry-footer">BUILD: v1.0.0-r23</footer>
            </div>

            <div id="victory" class="window"><h1>NIVEL COMPLETADO</h1><div id="victoryRankProgress"></div><button id="victoryToMenuButton">CONTINUAR</button></div>
            <div id="fullscreenOverlay" class="window" style="z-index: 999; background-color: rgba(0,0,0,0.95);"><h2>MODO PANTALLA COMPLETA REQUERIDO</h2><button id="reEnterFullscreenButton">REACTIVAR</button></div>
        </main>
    </div>
<script>
(function() {
    'use strict';
    function createEventBus() { var l={}; return { on:function(e,t){(l[e]=l[e]||[]).push(t)},off:function(e,t){l[e]&&(l[e]=l[e].filter(function(l){return l!==t}))},emit:function(e,t){l[e]&&l[e].forEach(function(l){l(t)})} }; }
    var EventBus = createEventBus();
    var state = { currentWindow: 'preload', activeProfile: null, profiles: {}, newPlayerName: '', isShiftActive: false, game: { isOver: false, isSelecting: false, selection: [], foundWords: [], activePuzzle: null, promoted: false, lastDifficulty: null, wordTimer: 0, wordTimerId: null, activeWordIndex: 0 } };
    var windows = { preload: document.getElementById('preload'), title: document.getElementById('title'), profiles: document.getElementById('profiles'), player: document.getElementById('player'), mainMenu: document.getElementById('mainMenu'), shop: document.getElementById('shop'), game: document.getElementById('game'), victory: document.getElementById('victory'), fullscreenOverlay: document.getElementById('fullscreenOverlay') };
    var ui = {
        profilesList: document.getElementById('profilesList'), goToPlayerCreateButton: document.getElementById('goToPlayerCreateButton'),
        playerNameDisplay: document.getElementById('playerNameDisplay'), virtualKeyboard: document.getElementById('virtualKeyboard'), cancelPlayerButton: document.getElementById('cancelPlayerButton'),
        mainMenuHeader: document.getElementById('mainMenuHeader'), levelGrid: document.getElementById('levelGrid'), backToProfilesButton: document.getElementById('backToProfilesButton'), goToShopButton: document.getElementById('goToShopButton'),
        shopHeader: document.getElementById('shop-header'), shopGrid: document.getElementById('shopGrid'), backToMenuButton: document.getElementById('backToMenuButton'),
        gameHeaderTitle: document.getElementById('gameHeaderTitle'), wordSearchGrid: document.getElementById('wordSearchGrid'), wordList: document.getElementById('wordList'), hintButton: document.getElementById('hint-button'), wordTimer: document.getElementById('word-timer'),
        victoryToMenuButton: document.getElementById('victoryToMenuButton'), reEnterFullscreenButton: document.getElementById('reEnterFullscreenButton'), holographicPanel: document.getElementById('holographic-panel'),
        victoryRankProgress: document.getElementById('victoryRankProgress')
    };
    var PROFILES_KEY = 'ws-profiles';
    var PLAYER_KEYBOARD_LAYOUT = ['Q','W','E','R','T','Y','U','Backspace','A','S','D','F','G','H','Enter','I','J','K','L','M','Ñ','O','P','Shift','Z','X','C','V','B','N'];
    var WORD_LISTS = {
        facil: ['API', 'BUG', 'BOT', 'BIT', 'BIOS', 'BLOG', 'BYTE', 'CACHE', 'CHIP', 'CHAT', 'CSS', 'DATO', 'DNS', 'DOM', 'DOS', 'DRM', 'EMAIL', 'FTP', 'GIF', 'GUI', 'HILO', 'HOST', 'HTML', 'HTTP', 'HUB', 'ICONO', 'JAVA', 'JSON', 'JQUERY', 'KERNEL', 'LAN', 'LINK', 'LOG', 'LUA', 'MAC'],
        medio: ['ARRAY', 'ASCII', 'AVATAR', 'ANCHO', 'BANDA', 'BETA', 'BACKUP', 'CLASE', 'CLIENTE', 'CODIGO', 'COOKIE', 'DRIVER', 'DEBUG', 'ENLACE', 'EVENTO', 'FRAME', 'FUENTE', 'FUNCION', 'GAMING', 'GMAIL', 'HASHTAG', 'HEADER', 'INDEX', 'INPUT', 'LATENCIA', 'LOGIN', 'LOOP', 'MASCARA', 'MATRIZ', 'NODO', 'NUBE', 'OBJETO', 'ONLINE', 'OUTPUT', 'PUNTERO'],
        dificil: ['ALGORITMO', 'ANALOGICO', 'APLICACION', 'ARCHIVO', 'BACKEND', 'BINARIO', 'BIOMETRIA', 'BLUETOOTH', 'COMPILAR', 'CODIFICAR', 'CONSOLA', 'CONSTANTE', 'CONTRASEÑA', 'CPU', 'CRIPTOGRAFIA', 'DEPURADOR', 'DESCARGAR', 'DIRECTORIO', 'ENCRIPTAR', 'FRAMEWORK', 'FIREWALL', 'GIGABYTE', 'HARDWARE', 'HACKATHON', 'HERTZ', 'INTERFAZ', 'INTERNET', 'INTRANET', 'JAVASCRIPT', 'LICENCIA', 'MALWARE', 'MEMORIA', 'METADATOS', 'MICROCHIP', 'MODULAR']
    };
    var DIRECTIONS = [{f:'H',x:1,y:0},{f:'V',x:0,y:1},{f:'D',x:1,y:1},{f:'HI',x:-1,y:0},{f:'VI',x:0,y:-1},{f:'DI',x:-1,y:-1},{f:'DA',x:1,y:-1},{f:'DAI',x:-1,y:1}];
    var RANKS = [ { name: 'RECLUTA', glyph: 'ˇ' }, { name: 'PRIVADO', glyph: '∧' }, { name: 'CORPORAL', glyph: '≡' }, { name: 'SARGENTO', glyph: '∗' }, { name: 'TENIENTE', glyph: '★' }, { name: 'CAPITÁN', glyph: '✪' }, { name: 'MAYOR', glyph: '✯' }, { name: 'CORONEL', glyph: '⚜' }, { name: 'GENERAL', glyph: '⚝' }, { name: 'MARISCAL', glyph: '✠' }];
    var SHOP_ITEMS = { hint_pack_1: { name: 'PAQUETE DE PISTAS', description: '3 pistas para usar en el juego.', cost: 500, onPurchase: function(p){ p.inventory.hints += 3; } } };

    function requestFullscreen() { var e = document.documentElement; if (e.requestFullscreen) e.requestFullscreen(); else if (e.webkitRequestFullscreen) e.webkitRequestFullscreen(); else if (e.mozRequestFullScreen) e.mozRequestFullScreen(); else if (e.msRequestFullscreen) e.msRequestFullscreen(); }
    function saveProfiles() { try { localStorage.setItem(PROFILES_KEY, JSON.stringify(state.profiles)); } catch(e) {} }
    function loadProfiles() {
        try {
            var p = JSON.parse(localStorage.getItem(PROFILES_KEY));
            if (p) {
                Object.keys(p).forEach(function(name) {
                    if (!p[name].ranks) p[name].ranks = { facil: 0, medio: 0, dificil: 0 };
                    if (!p[name].repetitions) p[name].repetitions = { facil: 0, medio: 0, dificil: 0 };
                    if (!p[name].usedWords) p[name].usedWords = { facil: [], medio: [], dificil: [] };
                    if (!p[name].creditos) p[name].creditos = 0;
                    if (!p[name].inventory) p[name].inventory = { hints: 3 };
                });
                state.profiles = p;
            }
        } catch (e) { state.profiles = {}; }
    }
    function showWindow(id) { for (var k in windows) { if(windows[k]) windows[k].classList.remove('active'); } if(windows[id]) windows[id].classList.add('active'); state.currentWindow = id; }
    function fisherYatesShuffle(a){var m=a.length,t,i;while(m){i=Math.floor(Math.random()*m--);t=a[m];a[m]=a[i];a[i]=t}return a}
    function renderProfiles() { ui.profilesList.innerHTML = ''; Object.keys(state.profiles).forEach(function(name) { var li = document.createElement('li'); li.className = 'profile-entry'; var btn = document.createElement('button'); btn.textContent = name; btn.className = 'interactive-button profile-button'; btn.dataset.profileName = name; var delBtn = document.createElement('button'); delBtn.textContent = 'X'; delBtn.className = 'delete-button'; delBtn.dataset.profileName = name; li.appendChild(btn); li.appendChild(delBtn); ui.profilesList.appendChild(li); }); }
    function renderPlayerKeyboard() { ui.virtualKeyboard.innerHTML = ''; PLAYER_KEYBOARD_LAYOUT.forEach(function(k) { var btn = document.createElement('button'); btn.className = 'interactive-button'; var t = k; if(k === 'Backspace') t='←'; if(k === 'Enter') t='↵'; if(k === 'Shift') t='⇧'; btn.textContent = t; btn.dataset.key = k; ui.virtualKeyboard.appendChild(btn); }); }
    
    function renderMainMenu() {
        if(!ui.levelGrid || !state.activeProfile) return;
        var profile = state.profiles[state.activeProfile];
        ui.mainMenuHeader.textContent = 'JUGADOR: ' + state.activeProfile + ' :: CRÉDITOS: ' + profile.creditos;
        ui.levelGrid.innerHTML = '';
        Object.keys(WORD_LISTS).forEach(function(diff) {
            var rankIndex = profile.ranks[diff]; var rank = RANKS[rankIndex]; var reps = profile.repetitions[diff];
            var card = document.createElement('button'); card.className = 'interactive-button level-card'; card.dataset.difficulty = diff;
            var badgeEl = document.createElement('div'); badgeEl.className = 'rank-badge';
            var glyphEl = document.createElement('span'); glyphEl.className = 'rank-glyph'; glyphEl.textContent = rank.glyph;
            badgeEl.appendChild(glyphEl);
            var infoEl = document.createElement('div'); infoEl.className = 'level-info';
            var levelNameEl = document.createElement('span'); levelNameEl.className = 'level-name'; levelNameEl.textContent = 'NIVEL ' + diff.toUpperCase();
            var rankNameEl = document.createElement('span'); rankNameEl.className = 'rank-name'; rankNameEl.textContent = rank.name;
            infoEl.appendChild(levelNameEl); infoEl.appendChild(rankNameEl);
            var repsEl = document.createElement('div'); repsEl.className = 'repetition-container';
            for (var i = 0; i < 3; i++) { var box = document.createElement('div'); box.className = 'repetition-box' + (i < reps ? ' filled' : ''); repsEl.appendChild(box); }
            card.appendChild(badgeEl); card.appendChild(infoEl); card.appendChild(repsEl);
            ui.levelGrid.appendChild(card);
        });
    }

    function renderShop() {
        var profile = state.profiles[state.activeProfile];
        ui.shopHeader.textContent = 'TIENDA :: ' + profile.creditos + ' CRÉDITOS';
        ui.shopGrid.innerHTML = '';
        Object.keys(SHOP_ITEMS).forEach(function(id) {
            var item = SHOP_ITEMS[id];
            var itemEl = document.createElement('div');
            itemEl.className = 'shop-item';
            itemEl.innerHTML = '<h3>'+item.name+'</h3><p>'+item.description+'</p><p class="cost">COSTO: '+item.cost+' CRÉDITOS</p>';
            var buyBtn = document.createElement('button');
            buyBtn.textContent = 'COMPRAR';
            buyBtn.dataset.itemId = id;
            if (profile.creditos < item.cost) buyBtn.disabled = true;
            itemEl.appendChild(buyBtn);
            ui.shopGrid.appendChild(itemEl);
        });
    }

    function generarNivelSopaDeLetras(difficulty) {
        var profile = state.profiles[state.activeProfile];
        var config = { facil: { size: 12, words: 7 }, medio: { size: 14, words: 7 }, dificil: { size: 16, words: 7 } }[difficulty];
        var masterList = WORD_LISTS[difficulty];
        var usedList = profile.usedWords[difficulty];
        var availableWords = masterList.filter(function(word) { return !usedList.includes(word); });
        if (availableWords.length < config.words) {
            profile.usedWords[difficulty] = [];
            usedList = [];
            availableWords = masterList;
        }
        var wordsToPlace = fisherYatesShuffle(availableWords).slice(0, config.words);
        profile.usedWords[difficulty] = usedList.concat(wordsToPlace);
        var grid = Array(config.size).fill(0).map(function() { return Array(config.size).fill(null); });
        var placedWords = [];
        wordsToPlace.forEach(function(word) {
            var attempts = 0;
            while (attempts < 100) {
                var dir = DIRECTIONS[Math.floor(Math.random() * DIRECTIONS.length)];
                var startX = Math.floor(Math.random() * config.size), startY = Math.floor(Math.random() * config.size);
                var endX = startX + (word.length - 1) * dir.x, endY = startY + (word.length - 1) * dir.y;
                if (endX >= 0 && endX < config.size && endY >= 0 && endY < config.size) {
                    var canPlace = true, cells = [];
                    for (var i = 0; i < word.length; i++) { var x = startX + i * dir.x, y = startY + i * dir.y; if (grid[y][x] !== null && grid[y][x] !== word[i]) { canPlace = false; break; } cells.push({ x: x, y: y }); }
                    if (canPlace) { for (var i = 0; i < word.length; i++) { grid[cells[i].y][cells[i].x] = word[i]; } placedWords.push({ text: word, cells: cells, direction: dir.f }); return; }
                }
                attempts++;
            }
        });
        for (var y = 0; y < config.size; y++) { for (var x = 0; x < config.size; x++) { if (grid[y][x] === null) { grid[y][x] = 'ABCDEFGHIJKLMNÑOPQRSTUVWXYZ'[Math.floor(Math.random() * 27)]; } } }
        return { grid: grid, words: placedWords, size: config.size };
    }

    var GameManager = {
        startGame: function(difficulty) { state.game.isOver = false; state.game.foundWords = []; state.game.difficulty = difficulty; state.game.promoted = false; state.game.activePuzzle = generarNivelSopaDeLetras(difficulty); this.renderGrid(); this.renderWordList(); ui.gameHeaderTitle.textContent = 'JUGADOR :: ' + state.activeProfile; this.moveToNextWord(true); EventBus.emit('system:requestNavigation', { windowId: 'game' }); },
        renderGrid: function() { var puzzle = state.game.activePuzzle; ui.wordSearchGrid.innerHTML = ''; ui.wordSearchGrid.style.setProperty('--grid-size', puzzle.size); puzzle.grid.forEach(function(row, y) { row.forEach(function(letter, x) { var cell = document.createElement('div'); cell.className = 'grid-cell'; cell.textContent = letter; cell.dataset.x = x; cell.dataset.y = y; ui.wordSearchGrid.appendChild(cell); }); }); },
        updateHud: function() {
            var hints = state.profiles[state.activeProfile].inventory.hints;
            ui.hintButton.textContent = '[ PISTA (' + hints + ') ]';
            ui.hintButton.disabled = hints <= 0;
            var minutes = Math.floor(state.game.wordTimer / 60); var seconds = state.game.wordTimer % 60;
            ui.wordTimer.textContent = (minutes < 10 ? '0':'') + minutes + ':' + (seconds < 10 ? '0':'') + seconds;
        },
        renderWordList: function() {
            var puzzle = state.game.activePuzzle; var profile = state.profiles[state.activeProfile]; var showHints = profile.ranks[state.game.difficulty] <= 1; 
            var dirMap = {H:'→',V:'↓',D:'↘',HI:'←',VI:'↑',DI:'↖',DA:'↗',DAI:'↙'};
            ui.wordList.innerHTML = '';
            puzzle.words.forEach(function(wordData, index) {
                var li = document.createElement('li'); var hint = showHints ? (dirMap[wordData.direction] || '') + ' ' : '';
                li.textContent = hint + wordData.text; li.dataset.word = wordData.text;
                if(state.game.foundWords.includes(wordData.text)) li.classList.add('found');
                if(index === state.game.activeWordIndex && !state.game.isOver) li.classList.add('active-word');
                ui.wordList.appendChild(li);
            });
            this.updateHud();
        },
        startWordTimer: function() { clearInterval(state.game.wordTimerId); state.game.wordTimer = 60; this.updateHud(); state.game.wordTimerId = setInterval(this.tick.bind(this), 1000); },
        tick: function() {
            state.game.wordTimer--; this.updateHud();
            if (state.game.wordTimer <= 0) { this.moveToNextWord(false); }
        },
        moveToNextWord: function(isFirstWord) {
            var puzzle = state.game.activePuzzle; var nextIndex = -1; var startIndex = isFirstWord ? 0 : state.game.activeWordIndex;
            for (var i = startIndex; i < puzzle.words.length; i++) { if (!state.game.foundWords.includes(puzzle.words[i].text)) { nextIndex = i; break; } }
            if (nextIndex === -1 && !isFirstWord) { for (var i = 0; i < state.game.activeWordIndex; i++) { if (!state.game.foundWords.includes(puzzle.words[i].text)) { nextIndex = i; break; } } }
            if (nextIndex !== -1) { state.game.activeWordIndex = nextIndex; this.startWordTimer(); this.renderWordList(); } 
            else { this.checkGameState(); }
        },
        handleSelectionEnd: function() {
            if (state.game.isSelecting) {
                state.game.isSelecting = false;
                if (state.game.selection.length < 2) { this.clearSelectionUI(); return; }
                var selectedString = state.game.selection.map(function(c){return c.textContent}).join('');
                var puzzle = state.game.activePuzzle;
                var foundWordData = puzzle.words.find(function(w) { return (w.text === selectedString || w.text === selectedString.split('').reverse().join('')) && !state.game.foundWords.includes(w.text); });
                
                if (foundWordData) {
                    state.game.foundWords.push(foundWordData.text);
                    var wasActiveWord = puzzle.words[state.game.activeWordIndex].text === foundWordData.text;
                    
                    var foundCells = [].slice.call(state.game.selection);
                    foundCells.forEach(function(cell) { cell.classList.remove('selected'); cell.classList.add('found'); });
                    setTimeout(function() {
                        foundCells.forEach(function(cell) { cell.classList.add('inactive'); });
                    }, 1000);

                    if (wasActiveWord) { 
                        var bonus = state.game.wordTimer;
                        state.profiles[state.activeProfile].creditos += bonus;
                        this.moveToNextWord(false);
                    } else {
                        this.renderWordList();
                    }
                    this.checkGameState();
                } else {
                    this.clearSelectionUI();
                }
            }
        },
        checkGameState: function() {
            if (state.game.foundWords.length === state.game.activePuzzle.words.length) {
                state.game.isOver = true; clearInterval(state.game.wordTimerId); var profile = state.profiles[state.activeProfile]; var difficulty = state.game.difficulty;
                profile.repetitions[difficulty]++;
                if (profile.repetitions[difficulty] >= 3) {
                    if (profile.ranks[difficulty] < RANKS.length - 1) { profile.ranks[difficulty]++; state.game.promoted = true; }
                    profile.repetitions[difficulty] = 0;
                }
                state.game.lastDifficulty = difficulty;
                saveProfiles(); setTimeout(function(){ EventBus.emit('game:victory'); }, 500);
            }
        },
        useHint: function() {
            var profile = state.profiles[state.activeProfile]; if (profile.inventory.hints <= 0) return;
            var unfoundWord = state.game.activePuzzle.words.find(function(w) { return !state.game.foundWords.includes(w.text); });
            if (unfoundWord) {
                profile.inventory.hints--;
                var firstLetterCell = unfoundWord.cells[0];
                var cellEl = ui.wordSearchGrid.querySelector('[data-x="' + firstLetterCell.x + '"][data-y="' + firstLetterCell.y + '"]');
                if (cellEl) { cellEl.classList.add('hint'); setTimeout(function() { cellEl.classList.remove('hint'); }, 1600); }
                saveProfiles(); this.updateHud();
            }
        },
        clearSelectionUI: function() { document.querySelectorAll('.grid-cell.selected').forEach(function(c) { c.classList.remove('selected'); }); }
    };
    function renderVictoryProgress() {
        var profile = state.profiles[state.activeProfile]; var difficulty = state.game.lastDifficulty; ui.victoryRankProgress.innerHTML = '';
        if (state.game.promoted) { var newRank = RANKS[profile.ranks[difficulty]]; ui.victoryRankProgress.innerHTML = '<h2 class="promotion-title">¡ASCENDIDO!</h2><p>NUEVO RANGO ('+difficulty.toUpperCase()+'): ' + newRank.glyph + ' ' + newRank.name + '</p>'; } 
        else { var reps = profile.repetitions[difficulty]; ui.victoryRankProgress.innerHTML = '<p>PROGRESO ('+difficulty.toUpperCase()+'): ' + reps + ' / 3</p>'; }
    }
    document.addEventListener('DOMContentLoaded', function() {
        loadProfiles(); renderProfiles(); renderPlayerKeyboard();
        var initialKeyListener = function() { EventBus.emit('system:requestNavigation', { windowId: 'profiles', requestFullscreen: true }); };
        windows.title.addEventListener('click', initialKeyListener, { once: true });
        document.addEventListener('keydown', initialKeyListener, { once: true });
        ui.goToPlayerCreateButton.addEventListener('click', function(){ showWindow('player'); });
        ui.cancelPlayerButton.addEventListener('click', function(){ showWindow('profiles'); });
        ui.backToProfilesButton.addEventListener('click', function(){ EventBus.emit('profile:clearActive'); });
        ui.victoryToMenuButton.addEventListener('click', function(){ showWindow('mainMenu'); renderMainMenu(); });
        ui.goToShopButton.addEventListener('click', function(){ showWindow('shop'); renderShop(); });
        ui.backToMenuButton.addEventListener('click', function(){ showWindow('mainMenu'); renderMainMenu(); });
        ui.hintButton.addEventListener('click', function() { GameManager.useHint(); });
        ui.reEnterFullscreenButton.addEventListener('click', function() { requestFullscreen(); });
        ui.profilesList.addEventListener('click', function(e) {
            var name = e.target.dataset.profileName; if (!name) return;
            if (e.target.classList.contains('profile-button')) { state.activeProfile = name; showWindow('mainMenu'); renderMainMenu(); } 
            else if (e.target.classList.contains('delete-button')) { EventBus.emit('profile:deleted', { profileName: name }); }
        });
        ui.levelGrid.addEventListener('click', function(e) { var card = e.target.closest('.level-card'); var diff = card ? card.dataset.difficulty : null; if (diff && state.activeProfile) { GameManager.startGame(diff); } });
        ui.wordSearchGrid.addEventListener('mousedown', function(e) { if(e.target.classList.contains('grid-cell')){ state.game.isSelecting = true; GameManager.clearSelectionUI(); state.game.selection = [e.target]; e.target.classList.add('selected'); } });
        ui.wordSearchGrid.addEventListener('mouseover', function(e) { if (state.game.isSelecting && e.target.classList.contains('grid-cell')) { GameManager.clearSelectionUI(); var startCell = state.game.selection[0], endCell = e.target; var startX = parseInt(startCell.dataset.x), startY = parseInt(startCell.dataset.y); var endX = parseInt(endCell.dataset.x), endY = parseInt(endCell.dataset.y); var dx = Math.sign(endX - startX), dy = Math.sign(endY - startY); if (Math.abs(endX - startX) !== Math.abs(endY - startY) && (startX !== endX && startY !== endY)) return; state.game.selection = [startCell]; var currX = startX, currY = startY; while (currX !== endX || currY !== endY) { currX += dx; currY += dy; var nextCell = ui.wordSearchGrid.querySelector('[data-x="' + currX + '"][data-y="' + currY + '"]'); if(nextCell) state.game.selection.push(nextCell); } state.game.selection.forEach(function(cell) { cell.classList.add('selected'); }); } });
        document.body.addEventListener('mouseup', function() { GameManager.handleSelectionEnd(); });
        document.body.addEventListener('mousemove', function(e) { if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return; var x = (e.clientX / window.innerWidth) - 0.5, y = (e.clientY / window.innerHeight) - 0.5; if(ui.holographicPanel) ui.holographicPanel.style.transform = 'rotateX(' + (10 + (y * -5)) + 'deg) rotateY(' + (x * 5) + 'deg)'; document.body.style.setProperty('--grid-x', (-x * 20) + 'px'); document.body.style.setProperty('--grid-y', (-y * 20) + 'px'); });
        
        EventBus.on('system:requestNavigation', function(d) { if (d.requestFullscreen) { requestFullscreen(); } if(d.windowId === 'mainMenu') { renderMainMenu(); } if(d.windowId) { showWindow(d.windowId); } });
        EventBus.on('game:victory', function() { renderVictoryProgress(); showWindow('victory'); });
        EventBus.on('profile:clearActive', function() { state.activeProfile = null; showWindow('profiles'); renderProfiles(); });
        EventBus.on('profile:deleted', function(d) { delete state.profiles[d.profileName]; saveProfiles(); renderProfiles(); });
        EventBus.on('shop:boughtItem', function(d) {
             var item = SHOP_ITEMS[d.itemId];
             var profile = state.profiles[state.activeProfile];
             if (profile.creditos >= item.cost) {
                profile.creditos -= item.cost;
                item.onPurchase(profile);
                saveProfiles();
                renderShop();
                renderMainMenu();
             }
        });
        ui.shopGrid.addEventListener('click', function(e){
            var btn = e.target.closest('button[data-item-id]');
            if(btn) { EventBus.emit('shop:boughtItem', { itemId: btn.dataset.itemId }); }
        });
        
        setTimeout(function() { showWindow('title'); }, 1000);
        console.log("Sistema WORD SEARCH v1.0.0-r23 estable inicializado.");
    });
})();
</script>
</body>
</html>
